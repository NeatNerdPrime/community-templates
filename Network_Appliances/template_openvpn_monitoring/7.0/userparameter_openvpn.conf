# OpenVPN monitoring UserParameters for Zabbix Agent 2
# Version: 1.0.0
# Compatible with: Zabbix 7.0+
#
# Installation:
# 1. Copy this file to /etc/zabbix/zabbix_agent2.d/
# 2. Restart zabbix-agent2 service
# 3. Test with: zabbix_agent2 -t openvpn.version
#
# Requirements:
# - OpenVPN installed and running
# - Status files in /var/log/openvpn/
# - Zabbix user has read permissions on log files

# Discovery of connected OpenVPN users
# Returns JSON formatted list of users for LLD
UserParameter=openvpn.discovery,/opt/zabbix/openvpn-discovery.sh

# Count total number of connected users
# Searches all status files and counts CLIENT_LIST entries
UserParameter=openvpn.user.number.new,find /var/log/openvpn -name "status*.log" -exec grep -c "^CLIENT_LIST" {} \; 2>/dev/null | awk "{sum += \$1} END {print sum+0}"

# Check if specific user is connected
# Parameter: Username
# Returns: 1 if connected, 0 if not
UserParameter=openvpn.user.status.new[*],grep -c "^CLIENT_LIST.*$1" /var/log/openvpn/status*.log 2>/dev/null | awk "BEGIN{sum=0} {sum+=\$1} END{print (sum>0)?1:0}"

# Get bytes received for specific user
# Parameter: Username
# Returns: Bytes received (from status file column 6)
UserParameter=openvpn.user.received.new[*],awk -F"," "/^CLIENT_LIST.*$1/{print \$6}" /var/log/openvpn/status*.log 2>/dev/null | head -1

# Get bytes sent for specific user
# Parameter: Username
# Returns: Bytes sent (from status file column 7)
UserParameter=openvpn.user.sent.new[*],awk -F"," "/^CLIENT_LIST.*$1/{print \$7}" /var/log/openvpn/status*.log 2>/dev/null | head -1

# Get OpenVPN version
# Returns: Version string (e.g., "2.5.9")
UserParameter=openvpn.version,openvpn --version 2>&1 | head -1 | awk "{print \$2}" | cut -d"_" -f1